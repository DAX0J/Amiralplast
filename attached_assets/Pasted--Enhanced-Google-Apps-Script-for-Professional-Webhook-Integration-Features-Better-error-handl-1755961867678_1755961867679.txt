// Enhanced Google Apps Script for Professional Webhook Integration
// Features: Better error handling, validation, logging, and CORS support

// ‚ö†Ô∏è CONFIGURATION - Ÿäÿ¨ÿ® ÿ™ÿ∫ŸäŸäÿ± Ÿáÿ∞Ÿá ÿßŸÑŸÇŸäŸÖ ‚ö†Ô∏è
const CONFIG = {
  // ÿßÿ≥ÿ™ÿ®ÿØŸÑ Ÿáÿ∞ÿß ÿ®ŸÄ ID ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ≠ŸÇŸäŸÇŸä
  SPREADSHEET_ID: "1EJ_GWcCZf1U245SfPm6aiKm8zhl_sQupW34dEfausMHR8FVYJkft-Rgt", // üî¥ ŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ∫ŸäŸäÿ± Ÿáÿ∞ÿß!

  // ÿßÿ≥ŸÖ ÿßŸÑŸàÿ±ŸÇÿ© ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ
  SHEET_NAME: "ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",

  // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ
  ENABLE_CORS: true,
  ENABLE_LOGGING: true,
  MAX_PAYLOAD_SIZE: 10000, // bytes

  // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÇŸÇ
  REQUIRED_FIELDS: [
    "fullName",
    "phone",
    "wilaya",
    "baladia",
    "deliveryType",
    "quantity",
    "totalPrice",
  ],
};

/**
 * Main webhook handler - enhanced with professional error handling
 */
function doPost(e) {
  try {
    // Set CORS headers for better browser compatibility
    if (CONFIG.ENABLE_CORS) {
      setCORSHeaders();
    }

    logInfo("üì• Received webhook request");

    // Validate and parse request
    const requestData = validateAndParseRequest(e);
    if (!requestData.success) {
      return createErrorResponse(requestData.error, 400);
    }

    // Process the order
    const result = processOrder(requestData.data);
    if (!result.success) {
      return createErrorResponse(result.error, 500);
    }

    // Success response
    logInfo("‚úÖ Order processed successfully");
    return createSuccessResponse(result.data);
  } catch (error) {
    logError("üí• Unexpected error in doPost:", error);
    return createErrorResponse(
      "Internal server error: " + error.toString(),
      500,
    );
  }
}

/**
 * Validate and parse incoming request
 */
function validateAndParseRequest(e) {
  try {
    // Check if request has data
    if (!e || !e.postData || !e.postData.contents) {
      return { success: false, error: "No data received" };
    }

    // Check payload size
    if (e.postData.contents.length > CONFIG.MAX_PAYLOAD_SIZE) {
      return { success: false, error: "Payload too large" };
    }

    // Parse JSON  
    let data;
    try {
      data = JSON.parse(e.postData.contents);
    } catch (parseError) {
      return {
        success: false,
        error: "Invalid JSON format: " + parseError.toString(),
      };
    }

    // Validate required fields
    const missingFields = CONFIG.REQUIRED_FIELDS.filter(
      (field) => !data[field],
    );
    if (missingFields.length > 0) {
      return {
        success: false,
        error: "Missing required fields: " + missingFields.join(", "),
      };
    }

    // Validate phone number format
    if (!isValidAlgerianPhone(data.phone)) {
      return { success: false, error: "Invalid phone number format" };
    }

    // Validate quantity
    if (data.quantity < 1 || data.quantity > 50) {
      return { success: false, error: "Invalid quantity (must be 1-50)" };
    }

    logInfo("‚úÖ Request validation passed");
    return { success: true, data: data };
  } catch (error) {
    return { success: false, error: "Validation error: " + error.toString() };
  }
}

/**
 * Process order and save to Google Sheets
 */
function processOrder(data) {
  try {
    // Check configuration
    if (CONFIG.SPREADSHEET_ID === "YOUR_SPREADSHEET_ID") {
      return { success: false, error: "Spreadsheet ID not configured" };
    }

    // Open spreadsheet
    let spreadsheet;
    try {
      spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    } catch (error) {
      return {
        success: false,
        error: "Cannot access spreadsheet: " + error.toString(),
      };
    }

    // Get or create sheet
    let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
    if (!sheet) {
      sheet = spreadsheet.insertSheet(CONFIG.SHEET_NAME);
      logInfo("üìä Created new sheet: " + CONFIG.SHEET_NAME);
    }

    // Initialize headers if needed
    if (sheet.getLastRow() === 0) {
      initializeHeaders(sheet);
    }

    // Generate order ID and timestamp
    const timestamp = new Date();
    const orderId = generateOrderId();

    // Prepare row data with enhanced formatting
    const rowData = [
      timestamp.toLocaleString("ar-DZ"), // ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™
      orderId, // ŸÖÿπÿ±ŸÅ ÿßŸÑÿ∑ŸÑÿ®
      sanitizeText(data.fullName), // ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ
      data.phone, // ÿßŸÑŸáÿßÿ™ŸÅ
      data.altPhone || "", // ÿßŸÑŸáÿßÿ™ŸÅ ÿßŸÑÿ´ÿßŸÜŸä
      sanitizeText(data.wilaya), // ÿßŸÑŸàŸÑÿßŸäÿ©
      sanitizeText(data.baladia), // ÿßŸÑÿ®ŸÑÿØŸäÿ©
      data.deliveryType === "home" ? "ŸÑŸÑŸÖŸÜÿ≤ŸÑ" : "ŸÑŸÑŸÖŸÉÿ™ÿ®", // ŸÜŸàÿπ ÿßŸÑÿ™ŸàÿµŸäŸÑ
      data.quantity, // ÿßŸÑŸÉŸÖŸäÿ©
      data.productPrice + " ÿØÿ¨", // ÿ≥ÿπÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨
      data.deliveryPrice + " ÿØÿ¨", // ÿ≥ÿπÿ± ÿßŸÑÿ™ŸàÿµŸäŸÑ
      data.totalPrice + " ÿØÿ¨", // ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä
      sanitizeText(data.notes || ""), // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
      data.fingerprint || "", // ÿßŸÑÿ®ÿµŸÖÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©
      "ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©", // ÿßŸÑÿ≠ÿßŸÑÿ©
      timestamp.toISOString(), // ISO Timestamp
    ];

    // Add row to sheet
    sheet.appendRow(rowData);

    // Format the new row
    formatNewRow(sheet, sheet.getLastRow());

    logInfo("üìù Order added to sheet successfully");

    return {
      success: true,
      data: {
        orderId: orderId,
        timestamp: timestamp.toISOString(),
        rowNumber: sheet.getLastRow(),
      },
    };
  } catch (error) {
    return { success: false, error: "Processing error: " + error.toString() };
  }
}

/**
 * Initialize sheet headers
 */
function initializeHeaders(sheet) {
  const headers = [
    "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™",
    "ŸÖÿπÿ±ŸÅ ÿßŸÑÿ∑ŸÑÿ®",
    "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
    "ÿßŸÑŸáÿßÿ™ŸÅ",
    "ÿßŸÑŸáÿßÿ™ŸÅ ÿßŸÑÿ´ÿßŸÜŸä",
    "ÿßŸÑŸàŸÑÿßŸäÿ©",
    "ÿßŸÑÿ®ŸÑÿØŸäÿ©",
    "ŸÜŸàÿπ ÿßŸÑÿ™ŸàÿµŸäŸÑ",
    "ÿßŸÑŸÉŸÖŸäÿ©",
    "ÿ≥ÿπÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨",
    "ÿ≥ÿπÿ± ÿßŸÑÿ™ŸàÿµŸäŸÑ",
    "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä",
    "ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™",
    "ÿßŸÑÿ®ÿµŸÖÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©",
    "ÿßŸÑÿ≠ÿßŸÑÿ©",
    "ISO Timestamp",
  ];

  sheet.appendRow(headers);

  // Format headers
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight("bold");
  headerRange.setBackground("#f0f0f0");
  headerRange.setHorizontalAlignment("center");

  // Auto-resize columns
  sheet.autoResizeColumns(1, headers.length);

  logInfo("üìã Headers initialized");
}

/**
 * Format newly added row
 */
function formatNewRow(sheet, rowNumber) {
  try {
    const range = sheet.getRange(rowNumber, 1, 1, sheet.getLastColumn());

    // Alternate row colors for better readability
    if (rowNumber % 2 === 0) {
      range.setBackground("#f9f9f9");
    }

    // Center align numeric columns
    const numericColumns = [9, 10, 11, 12]; // Quantity, prices
    numericColumns.forEach((col) => {
      if (col <= sheet.getLastColumn()) {
        sheet.getRange(rowNumber, col).setHorizontalAlignment("center");
      }
    });
  } catch (error) {
    logError("Formatting error:", error);
    // Non-critical error, continue
  }
}

/**
 * Generate unique order ID
 */
function generateOrderId() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 5).toUpperCase();
  return `ORD-${timestamp}-${random}`;
}

/**
 * Validate Algerian phone number
 */
function isValidAlgerianPhone(phone) {
  const phoneRegex = /^(077|055|066)\d{7}$/;
  return phoneRegex.test(phone);
}

/**
 * Sanitize text input to prevent injection
 */
function sanitizeText(text) {
  if (typeof text !== "string") return "";
  return text.replace(/[<>&"']/g, "").substring(0, 200);
}

/**
 * Set CORS headers for browser compatibility
 */
function setCORSHeaders() {
  // Note: Google Apps Script automatically handles CORS for web apps
  // This function is for reference and future enhancements
}

/**
 * Create success response
 */
function createSuccessResponse(data) {
  const response = {
    success: true,
    orderId: data.orderId,
    timestamp: data.timestamp,
    message: "Order added to Google Sheets successfully",
  };

  return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(
    ContentService.MimeType.JSON,
  );
}

/**
 * Create error response
 */
function createErrorResponse(message, statusCode = 400) {
  const response = {
    success: false,
    error: message,
    timestamp: new Date().toISOString(),
  };

  // Note: Google Apps Script doesn't support custom HTTP status codes
  // But we include it in the response for debugging

  return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(
    ContentService.MimeType.JSON,
  );
}

/**
 * Enhanced logging functions
 */
function logInfo(message) {
  if (CONFIG.ENABLE_LOGGING) {
    console.log(`[INFO] ${new Date().toISOString()}: ${message}`);
  }
}

function logError(message, error = null) {
  if (CONFIG.ENABLE_LOGGING) {
    console.error(`[ERROR] ${new Date().toISOString()}: ${message}`);
    if (error) {
      console.error(`[ERROR] Stack trace:`, error);
    }
  }
}

// üß™ Enhanced test functions

/**
 * Test the webhook with sample data
 */
function testDoPostEnhanced() {
  logInfo("üß™ Starting enhanced test...");

  const testData = {
    postData: {
      contents: JSON.stringify({
        fullName: "ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ - ÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ≠ÿ≥ŸÜ",
        phone: "0771234567",
        altPhone: "0551234567",
        wilaya: "ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±",
        baladia: "ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ± ÿßŸÑŸàÿ≥ÿ∑Ÿâ",
        deliveryType: "home",
        quantity: 2,
        productPrice: 5000,
        deliveryPrice: 600,
        totalPrice: 5600,
        notes: "ÿ∑ŸÑÿ® ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÖÿ≠ÿ≥ŸÜ ŸÖŸÜ Google Apps Script",
        fingerprint: "test123",
        timestamp: new Date().toISOString(),
      }),
    },
  };

  try {
    const result = doPost(testData);
    const content = result.getContent();
    logInfo("‚úÖ Enhanced test successful:", content);
    return JSON.parse(content);
  } catch (error) {
    logError("‚ùå Enhanced test failed:", error);
    return { success: false, error: error.toString() };
  }
}

/**
 * Check configuration and permissions
 */
function checkConfigurationEnhanced() {
  logInfo("üîç Checking enhanced configuration...");

  const results = {
    spreadsheetConfigured: false,
    spreadsheetAccessible: false,
    sheetExists: false,
    permissions: false,
  };

  // Check SPREADSHEET_ID
  if (CONFIG.SPREADSHEET_ID === "YOUR_SPREADSHEET_ID") {
    logError("‚ùå SPREADSHEET_ID not configured");
    return results;
  }
  results.spreadsheetConfigured = true;

  // Check spreadsheet access
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const name = spreadsheet.getName();
    logInfo("‚úÖ Spreadsheet accessible: " + name);
    results.spreadsheetAccessible = true;

    // Check sheet
    const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
    if (sheet) {
      logInfo("‚úÖ Sheet exists: " + CONFIG.SHEET_NAME);
      results.sheetExists = true;
    } else {
      logInfo("‚ö†Ô∏è Sheet will be created: " + CONFIG.SHEET_NAME);
    }

    // Test permissions by trying to write
    try {
      const testSheet = sheet || spreadsheet.insertSheet("test_permissions");
      testSheet.getRange("A1").setValue("Permission test");
      results.permissions = true;

      // Clean up test
      if (!sheet) {
        spreadsheet.deleteSheet(testSheet);
      }

      logInfo("‚úÖ Write permissions confirmed");
    } catch (permError) {
      logError("‚ùå No write permissions:", permError);
    }
  } catch (error) {
    logError("‚ùå Cannot access spreadsheet:", error);
  }

  logInfo("üìä Configuration check results:", JSON.stringify(results));
  return results;
}

/**
 * Initialize sample data for testing
 */
function initializeSampleData() {
  logInfo("üìù Initializing sample data...");

  const sampleOrders = [
    {
      fullName: "ŸÅÿßÿ∑ŸÖÿ© ÿ£ÿ≠ŸÖÿØ",
      phone: "0771234567",
      wilaya: "ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±",
      baladia: "ÿ®ÿßÿ® ÿßŸÑŸàÿßÿØ",
      deliveryType: "home",
      quantity: 1,
      productPrice: 2500,
      deliveryPrice: 600,
      totalPrice: 3100,
      notes: "ÿ∑ŸÑÿ® ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä",
    },
    {
      fullName: "ŸÖÿ≠ŸÖÿØ ÿπŸÑŸä",
      phone: "0551234567",
      wilaya: "ŸàŸáÿ±ÿßŸÜ",
      baladia: "ŸàŸáÿ±ÿßŸÜ",
      deliveryType: "office",
      quantity: 2,
      productPrice: 5000,
      deliveryPrice: 400,
      totalPrice: 5400,
      notes: "ÿπÿ±ÿ∂ 2+1 ŸÖÿ¨ÿßŸÜÿßŸã",
    },
  ];

  sampleOrders.forEach((order, index) => {
    const testData = {
      postData: {
        contents: JSON.stringify({
          ...order,
          fingerprint: `sample${index}`,
          timestamp: new Date().toISOString(),
        }),
      },
    };

    try {
      doPost(testData);
      logInfo(`‚úÖ Sample order ${index + 1} added`);
    } catch (error) {
      logError(`‚ùå Sample order ${index + 1} failed:`, error);
    }
  });

  logInfo("üéâ Sample data initialization completed");
}
